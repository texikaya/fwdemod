# TODO:  Figure out the hop tables. This should be pretty simple to figure out.
# There are 15 fixed hop patterns.  The offset in the pattern looks like it's in
# the header.  We can just scan each frequency for packets,  record the
# frequency for that offset..  and try all 15 tables..


symbol_rates={1: 230400, 2:153600, 3:115200}


# Packet Sizes
# From:
# https://archive.eol.ucar.edu/docs/isf/facilities/isff/communications/freewaveMAN42f.PDF
# https://www.rspsupply.com/images/downloads/Freewave/R/Freewave%20Radio%20FGRIO-S/FreeWave%20Radio%20FGRIO-S%20User%20Manual.pdf

# index is [min_packet_size]
min_packet_size = [8, 12, 16, 20, 24, 28, 32, 36, 40, 44]
min_packet_size_2 = [16, 21, 26, 32, 37, 42, 48, 53, 58, 64]

max_packet_size = {
    2:
    [
        [15, 36, 58, 79, 100, 121, 143, 164, 185, 206],
        [20, 42, 63, 84, 105, 127, 148, 169, 190, 212],
        [26, 47, 68, 90, 111, 132, 153, 175, 196, 217],
        [31, 52, 74, 95, 116, 137, 159, 180, 201, 222],
        [36, 58, 79, 100, 121, 143, 164, 185, 206, 228],
        [42, 63, 84, 105, 127, 148, 169, 190, 212, 233],
        [47, 68, 90, 111, 132, 153, 175, 196, 217, 238],
        [52, 74, 95, 116, 137, 159, 180, 201, 222, 244],
        [58, 79, 100, 121, 143, 164, 185, 206, 228, 249],
        [63, 84, 95, 127, 148, 169, 190, 212, 233, 254]
    ],
    3:
    [
        [8, 24, 40, 56, 72, 88, 104, 120, 136, 152],
        [12, 28, 44, 60, 76, 92, 108, 124, 140, 156],
        [16, 32, 48, 64, 80, 96, 112, 128, 144, 160],
        [20, 36, 52, 68, 84, 100, 116, 132, 148, 164],
        [24, 40, 56, 72, 88, 104, 120, 136, 152, 168],
        [28, 44, 60, 76, 92, 108, 124, 140, 156, 172],
        [32, 48, 64, 80, 96, 112, 128, 144, 160, 176],
        [36, 52, 68, 84, 100, 116, 132, 148, 164, 180],
        [40, 56, 72, 88, 104, 120, 136, 152, 168, 184],
        [44, 60, 76, 92, 108, 124, 140, 156, 172, 188],
    ]
}

# This is the period where we revisit a channel based on _min/_max packet size.
# This was with Zones 0xffff and with hop_table 0.  It's not clear if that Affects the
# period.  It probably does.
# In this config it looks like this is 112 x the slot time.
# TODO:  Measure all of these.  Hopefully they are uniq.
revisit_time = [
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 2.224450, 0],
    ]


# packet_period = [
#     [0.01194444, 0.01416667, 0.01638889, 0.01861111, 0.02083333, 0.02305556, 0.02527778, 0.0275, 0.02972222, 0.03194444],
#     [0.01305556, 0.01527778, 0.0175, 0.01972222, 0.02194444, 0.02416667, 0.02638889, 0.02861111, 0.03083333, 0.03305556],
#     [0.01416667, 0.01638889, 0.01861111, 0.02083333, 0.02305556, 0.02527778, 0.0275, 0.02972222, 0.03194444, 0.03416667],
#     [0.01527778, 0.0175, 0.01972222, 0.02194444, 0.02416667, 0.02638889, 0.02861111, 0.03083333, 0.03305556, 0.03527778],
#     [0.01638889, 0.01861111, 0.02083333, 0.02305556, 0.02527778, 0.0275, 0.02972222, 0.03194444, 0.03416667, 0.03638889],
#     [0.0175, 0.01972222, 0.02194444, 0.02416667, 0.02638889, 0.02861111, 0.03083333, 0.03305556, 0.03527778, 0.0375],
#     [0.01861111, 0.02083333, 0.02305556, 0.02527778, 0.0275, 0.02972222, 0.03194444, 0.03416667, 0.03638889, 0.03861111],
#     [0.01972222, 0.02194444, 0.02416667, 0.02638889, 0.02861111, 0.03083333, 0.03305556, 0.03527778, 0.0375, 0.03972222],
#     [0.02083333, 0.02305556, 0.02527778, 0.0275, 0.02972222, 0.03194444, 0.03416667, 0.03638889, 0.03861111, 0.04083333],
#     [0.02194444, 0.02416667, 0.02638889, 0.02861111, 0.03083333, 0.03305556, 0.03527778, 0.0375, 0.03972222, 0.04194444]
# ]

packet_period = [
    [0.00597222, 0.007083335, 0.008194445, 0.009305555, 0.010416665, 0.01152778, 0.01263889, 0.01375, 0.01486111, 0.01597222], 
    [0.00652778, 0.00763889, 0.00875, 0.00986111, 0.01097222, 0.012083335, 0.013194445, 0.014305555, 0.015416665, 0.01652778], 
    [0.007083335, 0.008194445, 0.009305555, 0.010416665, 0.01152778, 0.01263889, 0.01375, 0.01486111, 0.01597222, 0.017083335], 
    [0.00763889, 0.00875, 0.00986111, 0.01097222, 0.012083335, 0.013194445, 0.014305555, 0.015416665, 0.01652778, 0.01763889], 
    [0.008194445, 0.009305555, 0.010416665, 0.01152778, 0.01263889, 0.01375, 0.01486111, 0.01597222, 0.017083335, 0.018194445], 
    [0.00875, 0.00986111, 0.01097222, 0.012083335, 0.013194445, 0.014305555, 0.015416665, 0.01652778, 0.01763889, 0.01875], 
    [0.009305555, 0.010416665, 0.01152778, 0.01263889, 0.01375, 0.01486111, 0.01597222, 0.017083335, 0.018194445, 0.019305555], 
    [0.00986111, 0.01097222, 0.012083335, 0.013194445, 0.014305555, 0.015416665, 0.01652778, 0.01763889, 0.01875, 0.01986111], 
    [0.010416665, 0.01152778, 0.01263889, 0.01375, 0.01486111, 0.01597222, 0.017083335, 0.018194445, 0.019305555, 0.020416665], 
    [0.01097222, 0.012083335, 0.013194445, 0.014305555, 0.015416665, 0.01652778, 0.01763889, 0.01875, 0.01986111, 0.02097222]
    ]


periods = {}
for _min, _maxs in enumerate(packet_period):
    for _max, period in enumerate(_maxs):
        if period not in periods:
            periods[period] = set()
        periods[period].add((_min, _max))


# This corresponds to Appendix D in the user manual
channel_frequency = [
    902246400, 902476800, 902707200, 902937600, 903168000, 903398400, 903628800, 903859200,  # 1(0-7)
    904089600, 904320000, 904550400, 904780800, 905011200, 905241600, 905472000,  # 2(8-14)
    905702400, 905932800, 906163200, 906393600, 906624000, 906854400, 907084800,  # 3(15-21)
    907315200, 907545600, 907776000, 908006400, 908236800, 908467200, 908697600,  # 4(22-28)
    908928000, 909158400, 909388800, 909619200, 909849600, 910080000, 910310400,  # 5(29-35)
    910540800, 910771200, 911001600, 911232000, 911462400, 911692800, 911923200,  # 6(36-42)
    912153600, 912384000, 912614400, 912844800, 913075200, 913305600, 913536000,  # 7(43-49)
    913766400, 913996800, 914227200, 914457600, 914688000, 914918400, 915148800,  # 8(50-56)
    915379200, 915609600, 915840000, 916070400, 916300800, 916531200, 916761600,  # 9(57-63)
    916992000, 917222400, 917452800, 917683200, 917913600, 918144000, 918374400, 918604800,  # 10(64-71)
    918835200, 919065600, 919296000, 919526400, 919756800, 919987200, 920217600,  # 11(72-78)
    920448000, 920678400, 920908800, 921139200, 921369600, 921600000, 921830400,  # 12(79-85)
    922060800, 922291200, 922521600, 922752000, 922982400, 923212800, 923443200,  # 13(86-92)
    923673600, 923904000, 924134400, 924364800, 924595200, 924825600, 925056000,  # 14(93-99)
    925286400, 925516800, 925747200, 925977600, 926208000, 926438400, 926668800,  # 15(100-106)
    926899200, 927129600, 927360000, 927590400, 927820800  # 16(107-111)
]


# TODO:  Figure out the hop tables. This should be pretty simple to figure out.
# There are 15 fixed hop patterns.  The offset in the pattern looks like it's in
# the header.  We can just scan each frequency for packets,  record the
# frequency for that offset..  and try all 15 tables..

# The frequency hop table correspond to indexes in the channel_frequency list
# TODO: verify hop table 15 is correctly just a linear step through the frequency IDs above.
# It might also be some single channel thing, but it's not clear how to set the channel.
# Really this changes based on the Frequency Key.  in the UI "hop table" is something else.  "hop table"
# in the ui looks like it masks the channels somehow.  Maybe similar to zones.

# channel = hop_tables[frequency_key][packet_offset]
hop_tables = [
    # Frequency Key 0
    [91, 11, 47, 58, 26, 67, 10, 87, 9, 72, 98, 31, 52, 81, 22, 1, 12, 60, 107, 89, 59, 42, 78, 4, 65, 103, 15, 27, 66, 96, 44, 35, 90, 62, 34, 16, 105, 55, 106, 85, 43, 77, 29, 19, 86, 99, 30, 74, 49, 109, 57, 25, 17, 75, 3, 101, 48, 2, 93, 38, 111, 69, 56, 0, 24, 92, 70, 18, 39, 79, 45, 13, 110, 68, 7, 44, 36, 20, 95, 84, 53, 5, 104, 40, 23, 14, 97, 88, 76, 64, 108, 33, 83, 8, 102, 37, 82, 71, 61, 94, 45, 6, 28, 46, 80, 100, 63, 41, 21, 73, 54, 32],
    # Frequency Key 1
    [0, 55, 111, 37, 74, 16, 95, 68, 25, 46, 107, 9, 61, 86, 31, 102, 80, 20, 4, 52, 91, 41, 13, 65, 105, 71, 28, 57, 99, 34, 77, 7, 52, 109, 23, 63, 44, 83, 2, 94, 18, 104, 49, 88, 11, 70, 58, 39, 98, 26, 79, 66, 5, 89, 106, 32, 47, 14, 72, 56, 100, 40, 82, 1, 29, 54, 110, 75, 92, 17, 43, 84, 6, 62, 22, 36, 76, 103, 90, 35, 67, 8, 78, 19, 85, 30, 108, 60, 42, 12, 73, 52, 3, 97, 24, 64, 49, 93, 15, 38, 59, 27, 87, 101, 45, 10, 81, 21, 96, 53, 33, 69],
    # Frequency Key 2
    [92, 8, 80, 25, 7, 74, 111, 26, 57, 1, 67, 75, 45, 66, 104, 28, 94, 19, 105, 81, 36, 58, 73, 16, 98, 35, 97, 72, 17, 108, 52, 83, 61, 24, 39, 13, 102, 29, 71, 91, 12, 90, 55, 63, 18, 77, 99, 3, 47, 82, 32, 100, 110, 43, 70, 54, 93, 5, 14, 23, 37, 106, 60, 4, 85, 68, 38, 22, 95, 9, 44, 15, 53, 21, 78, 44, 87, 33, 6, 20, 86, 76, 48, 65, 107, 96, 27, 84, 49, 34, 59, 101, 79, 40, 46, 88, 64, 45, 10, 31, 2, 109, 89, 103, 56, 69, 41, 11, 0, 30, 42, 62],
    # Frequency Key 3
    [37, 69, 86, 8, 95, 61, 85, 27, 45, 101, 46, 1, 35, 102, 2, 57, 23, 76, 56, 38, 67, 31, 16, 108, 77, 52, 0, 63, 44, 22, 98, 75, 88, 106, 45, 34, 21, 105, 11, 60, 12, 94, 33, 111, 53, 90, 20, 64, 104, 47, 91, 70, 26, 17, 39, 84, 3, 25, 107, 43, 59, 30, 92, 29, 42, 93, 82, 9, 71, 55, 36, 10, 66, 100, 89, 15, 58, 83, 65, 40, 4, 48, 5, 18, 109, 97, 81, 41, 80, 54, 6, 73, 28, 68, 99, 7, 32, 87, 14, 72, 110, 24, 78, 96, 49, 62, 13, 74, 19, 79, 44, 103],
    # Frequency Key 4
    [102, 3, 85, 34, 43, 33, 77, 62, 99, 49, 6, 107, 32, 72, 59, 98, 48, 86, 0, 10, 1, 101, 24, 90, 68, 47, 8, 56, 23, 89, 2, 37, 15, 76, 88, 67, 108, 45, 81, 27, 75, 97, 111, 61, 19, 105, 35, 104, 92, 28, 52, 93, 44, 103, 45, 58, 79, 57, 36, 96, 44, 73, 25, 82, 4, 18, 60, 38, 83, 11, 65, 54, 12, 78, 110, 41, 100, 29, 66, 94, 42, 21, 106, 71, 7, 95, 84, 20, 31, 55, 40, 30, 69, 9, 109, 87, 17, 39, 16, 80, 53, 26, 91, 70, 5, 63, 46, 14, 74, 22, 13, 64],
    # Frequency Key 5
    [90, 103, 89, 58, 110, 45, 4, 65, 20, 76, 28, 88, 54, 71, 41, 7, 98, 40, 109, 81, 61, 18, 33, 80, 108, 24, 79, 49, 1, 9, 36, 10, 91, 47, 19, 30, 70, 102, 55, 14, 87, 106, 0, 26, 95, 25, 43, 62, 73, 17, 44, 101, 56, 23, 68, 57, 37, 93, 74, 67, 5, 105, 46, 104, 27, 53, 66, 42, 8, 99, 86, 75, 35, 111, 15, 63, 34, 69, 2, 64, 85, 16, 29, 96, 38, 72, 97, 82, 6, 32, 48, 59, 83, 31, 39, 92, 11, 45, 100, 77, 107, 12, 60, 78, 13, 94, 21, 44, 84, 3, 52, 22],
    # Frequency Key 6
    [71, 17, 44, 16, 78, 60, 39, 77, 107, 12, 87, 63, 40, 3, 97, 55, 18, 104, 43, 30, 80, 96, 31, 10, 23, 1, 102, 88, 66, 49, 7, 57, 92, 81, 35, 46, 34, 5, 14, 99, 53, 106, 68, 52, 41, 19, 79, 6, 72, 61, 42, 32, 62, 95, 73, 21, 47, 4, 100, 108, 76, 22, 8, 93, 109, 67, 36, 84, 94, 24, 44, 83, 103, 25, 45, 65, 11, 33, 64, 86, 2, 111, 13, 74, 28, 20, 105, 54, 37, 70, 0, 29, 90, 45, 82, 69, 58, 89, 48, 15, 110, 27, 101, 26, 56, 75, 85, 9, 98, 38, 59, 91],
    # Frequency Key 7
    [36, 110, 73, 26, 7, 44, 16, 52, 25, 94, 2, 59, 48, 77, 9, 85, 24, 33, 69, 111, 97, 86, 11, 37, 17, 44, 80, 103, 62, 93, 71, 108, 42, 5, 79, 30, 107, 4, 41, 31, 18, 106, 10, 66, 98, 19, 83, 39, 60, 74, 53, 109, 68, 8, 87, 57, 88, 78, 35, 95, 22, 45, 13, 67, 55, 96, 38, 82, 6, 45, 56, 102, 21, 81, 70, 34, 3, 43, 75, 63, 20, 28, 49, 91, 105, 29, 58, 15, 76, 46, 64, 90, 40, 101, 27, 0, 84, 14, 65, 92, 32, 99, 1, 23, 100, 54, 89, 61, 47, 12, 104, 72],
    # Frequency Key 8
    [96, 44, 33, 8, 79, 60, 44, 16, 70, 102, 6, 32, 17, 43, 61, 5, 24, 76, 93, 42, 68, 12, 31, 109, 94, 80, 18, 46, 36, 53, 100, 11, 1, 99, 27, 52, 20, 62, 98, 82, 108, 73, 29, 13, 39, 30, 107, 83, 38, 97, 84, 106, 54, 77, 105, 55, 9, 67, 88, 23, 95, 81, 57, 41, 66, 56, 14, 2, 111, 37, 92, 104, 65, 49, 28, 71, 22, 90, 47, 35, 101, 89, 48, 21, 78, 4, 64, 86, 45, 103, 34, 7, 69, 15, 0, 85, 40, 75, 63, 26, 110, 91, 3, 72, 10, 19, 59, 45, 58, 87, 25, 74],
    # Frequency Key 9
    [49, 5, 38, 60, 88, 97, 32, 22, 46, 66, 9, 55, 96, 18, 84, 54, 42, 108, 72, 2, 15, 25, 36, 91, 79, 24, 59, 11, 80, 10, 29, 37, 4, 103, 86, 64, 17, 41, 73, 28, 74, 27, 6, 98, 87, 67, 104, 19, 8, 68, 26, 49, 83, 100, 7, 16, 53, 99, 63, 23, 71, 1, 81, 44, 34, 94, 35, 93, 82, 109, 45, 14, 52, 45, 92, 77, 105, 65, 21, 3, 57, 78, 12, 90, 58, 69, 48, 0, 33, 62, 106, 40, 76, 107, 95, 39, 30, 70, 31, 44, 111, 61, 85, 101, 56, 43, 20, 102, 89, 75, 13, 110],
    # Frequency Key 10
    [62, 44, 9, 91, 19, 39, 31, 86, 76, 12, 104, 58, 11, 92, 26, 93, 57, 1, 99, 75, 65, 107, 14, 37, 71, 23, 88, 48, 106, 5, 16, 33, 55, 68, 22, 102, 56, 80, 41, 81, 109, 47, 94, 74, 13, 42, 32, 85, 69, 24, 101, 36, 4, 43, 59, 3, 82, 35, 70, 52, 60, 10, 110, 83, 27, 73, 84, 103, 15, 0, 53, 63, 77, 64, 21, 6, 97, 20, 38, 49, 108, 25, 96, 72, 8, 87, 2, 95, 40, 18, 79, 105, 34, 46, 89, 66, 7, 17, 100, 111, 78, 30, 90, 45, 45, 61, 29, 67, 54, 98, 44, 28],
    # Frequency Key 11
    [108, 98, 31, 79, 16, 91, 48, 104, 0, 83, 111, 6, 43, 29, 18, 101, 77, 56, 90, 36, 100, 5, 66, 45, 54, 75, 44, 20, 60, 92, 14, 37, 3, 55, 87, 28, 64, 13, 42, 23, 86, 59, 33, 68, 19, 69, 78, 52, 109, 15, 46, 35, 8, 80, 65, 99, 1, 74, 26, 44, 84, 34, 58, 45, 17, 25, 88, 40, 7, 89, 102, 30, 81, 103, 71, 2, 21, 96, 85, 27, 63, 12, 97, 38, 73, 110, 22, 39, 67, 9, 93, 53, 107, 62, 106, 41, 11, 61, 94, 72, 24, 82, 32, 47, 95, 105, 76, 4, 57, 10, 49, 70],
    # Frequency Key 12
    [6, 27, 92, 44, 99, 37, 52, 82, 2, 43, 25, 98, 44, 72, 35, 24, 55, 104, 30, 85, 29, 70, 7, 93, 45, 14, 86, 105, 67, 32, 60, 46, 20, 33, 79, 12, 95, 53, 80, 39, 101, 61, 111, 88, 62, 78, 16, 0, 71, 87, 15, 64, 21, 100, 109, 42, 108, 3, 91, 59, 38, 90, 8, 75, 45, 110, 19, 89, 40, 9, 34, 74, 56, 96, 83, 26, 66, 57, 65, 102, 41, 84, 13, 31, 103, 4, 58, 18, 81, 28, 68, 17, 69, 5, 49, 23, 97, 73, 48, 11, 63, 10, 47, 36, 106, 1, 94, 77, 22, 76, 107, 54],
    # Frequency Key 13
    [56, 44, 108, 55, 66, 20, 35, 9, 73, 54, 98, 42, 74, 22, 0, 61, 90, 12, 67, 78, 53, 110, 30, 44, 2, 92, 104, 63, 76, 40, 77, 52, 87, 15, 96, 70, 26, 102, 37, 80, 109, 5, 97, 64, 13, 31, 14, 1, 106, 91, 7, 23, 84, 32, 58, 49, 18, 85, 8, 28, 71, 17, 111, 62, 3, 48, 83, 36, 100, 4, 43, 89, 75, 101, 60, 11, 21, 94, 6, 47, 68, 59, 29, 41, 103, 81, 10, 82, 93, 33, 107, 24, 16, 65, 46, 72, 86, 34, 105, 45, 27, 45, 88, 19, 57, 39, 95, 38, 79, 69, 99, 25],
    # Frequency Key 14
    [65, 32, 43, 90, 14, 69, 31, 23, 101, 39, 100, 58, 68, 111, 11, 49, 35, 110, 57, 72, 83, 41, 10, 42, 106, 59, 97, 21, 70, 87, 53, 96, 22, 9, 82, 40, 76, 47, 5, 63, 25, 80, 102, 79, 92, 34, 56, 1, 64, 0, 48, 12, 45, 95, 13, 105, 85, 104, 71, 26, 38, 78, 93, 61, 44, 109, 8, 33, 60, 17, 81, 44, 89, 55, 88, 77, 30, 54, 4, 16, 98, 3, 108, 84, 62, 29, 99, 2, 15, 107, 91, 28, 20, 74, 7, 37, 45, 24, 86, 67, 36, 103, 19, 75, 66, 94, 46, 27, 6, 73, 18, 52],
    # Frequency Key 15
    #[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111],
]
# fkey_table = [[] for _ in range(0, len(channel_frequency))]
# for fkey, offset_table in enumerate(hop_tables):
#    for offset, channel in enumerate(offset_table):
#         fkey_table[channel][offset] = fkey
